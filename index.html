<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gadget Credit Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 20px; font-family: sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .total-banner { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        .btn-pay { background-color: #27ae60; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="total-banner text-center">
        <small>Current Outstanding Debt</small>
        <h1 id="totalBalance">K0.00</h1>
    </div>

    <div class="card p-4">
        <h5 class="mb-3">New Sale Entry</h5>
        <div class="row g-3">
            <div class="col-md-4"><input type="text" id="name" class="form-control" placeholder="Customer Name"></div>
            <div class="col-md-2"><input type="text" id="room" class="form-control" placeholder="Room #"></div>
            <div class="col-md-2"><input type="text" id="phone" class="form-control" placeholder="Phone Number"></div>
            <div class="col-md-2"><input type="text" id="item" class="form-control" placeholder="Gadget Name"></div>
            <div class="col-md-2"><input type="number" id="cost" class="form-control" placeholder="Price"></div>
            <div class="col-12"><button onclick="addRecord()" class="btn btn-primary w-100">Save Record</button></div>
        </div>
    </div>

    <div class="card p-4">
        <h5 class="mb-3">Active Credit List</h5>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Customer</th>
                        <th>Item</th>
                        <th>Cost</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwP0C5AqfBLOM-r6P4zI_nuj1LSAB18uivdb1Dv-2Vy5xZS-MGt9TDtaN1k92SIgTRFvw/exec"; 
    const MASTER_PASSWORD = "shamenda1131"; 

    // SECURITY CHECK
    const auth = prompt("Enter Admin Password:");
    if (auth !== MASTER_PASSWORD) {
        document.body.innerHTML = "<h2 class='text-center mt-5'>Access Denied</h2>";
        throw new Error("Unauthorized");
    }

    async function loadData() {
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action: 'read'}) });
        const data = await res.json();
        let html = "";
        let total = 0;

        data.forEach(row => {
            total += parseFloat(row[7]);
            html += `<tr>
                <td><strong>${row[1]}</strong><br><small class='text-muted'>Room: ${row[2]} | ${row[3]}</small></td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
                <td>${row[6]}</td>
                <td class="text-danger"><strong>${row[7]}</strong></td>
                <td>
                    <button class="btn btn-sm btn-pay" onclick="makePayment('${row[0]}')">Add Payment</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deleteRecord('${row[0]}')">Archive</button>
                </td>
            </tr>`;
        });
        document.getElementById('dataTable').innerHTML = html;
        document.getElementById('totalBalance').innerText = "K" + total.toFixed(2);
    }

    async function addRecord() {
        const payload = {
            action: 'addRow',
            name: document.getElementById('name').value,
            room: document.getElementById('room').value,
            phone: document.getElementById('phone').value,
            item: document.getElementById('item').value,
            cost: document.getElementById('cost').value
        };
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        location.reload();
    }

    async function makePayment(id) {
        const amount = prompt("Amount paid today:");
        if (amount) {
            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action: 'update', id: id, amount: amount}) });
            loadData();
        }
    }

    async function deleteRecord(id) {
        if (confirm("Move this record to Archive?")) {
            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action: 'delete', id: id}) });
            loadData();
        }
    }

    loadData();
</script>
</body>
</html>