<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gadget Pro Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; padding: 20px; font-family: sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .total-banner { background: #2c3e50; color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
        .blur-text { filter: blur(10px); cursor: pointer; transition: 0.3s; }
        .search-box { border-radius: 20px; border: 2px solid #dee2e6; padding-left: 15px; }
        
        /* LOADING OVERLAY */
        #loader {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3"><strong>Processing... Please wait</strong></p>
</div>

<div class="container">
    <div class="total-banner text-center">
        <p class="mb-1 text-uppercase small">Total Outstanding Credit</p>
        <h1 id="totalBalance" class="blur-text">K0.00</h1>
        <button onclick="toggleBalance()" class="btn btn-sm btn-outline-light mt-2" id="toggleBtn">Show Balance</button>
    </div>

    <div class="card p-4">
        <h5 class="mb-3 text-secondary">New Sale Entry</h5>
        <div class="row g-3">
            <div class="col-md-3"><input type="text" id="name" class="form-control" placeholder="Customer Name"></div>
            <div class="col-md-2"><input type="text" id="room" class="form-control" placeholder="Room #"></div>
            <div class="col-md-2"><input type="text" id="phone" class="form-control" placeholder="Phone"></div>
            <div class="col-md-2"><input type="text" id="item" class="form-control" placeholder="Item"></div>
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text">K</span>
                    <input type="number" id="cost" class="form-control" placeholder="Price">
                    <button onclick="addRecord()" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 text-secondary">Credit List</h5>
            <input type="text" id="searchInput" class="form-control w-50 search-box" placeholder="ðŸ” Search name..." onkeyup="filterTable()">
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr><th>Date</th><th>Customer</th><th>Item</th><th>Balance</th><th>Actions</th></tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwP0C5AqfBLOM-r6P4zI_nuj1LSAB18uivdb1Dv-2Vy5xZS-MGt9TDtaN1k92SIgTRFvw/exec";
    const MASTER_PASSWORD = "shamenda@1131";

    function toggleLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    const auth = prompt("Admin Password:");
    if (auth !== MASTER_PASSWORD) {
        document.body.innerHTML = "<h2 class='text-center mt-5'>Unauthorized</h2>";
        throw new Error("Exit");
    }

    function toggleBalance() {
        const bal = document.getElementById('totalBalance');
        const btn = document.getElementById('toggleBtn');
        if (bal.classList.contains('blur-text')) {
            bal.classList.remove('blur-text');
            btn.innerText = "Hide Balance";
        } else {
            bal.classList.add('blur-text');
            btn.innerText = "Show Balance";
        }
    }

    async function loadData() {
        toggleLoader(true);
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action: 'read'}) });
        const data = await res.json();
        let html = ""; let total = 0;
        data.forEach(row => {
            total += parseFloat(row[7]);
            html += `<tr>
                <td><small>${row[8] || '-'}</small></td>
                <td><strong>${row[1]}</strong><br><small>${row[2]}</small></td>
                <td>${row[4]}</td>
                <td class="text-danger"><strong>K${row[7]}</strong></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="makePayment('${row[0]}')">Pay</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deleteRecord('${row[0]}')">Archive</button>
                </td>
            </tr>`;
        });
        document.getElementById('dataTable').innerHTML = html;
        document.getElementById('totalBalance').innerText = "K" + total.toFixed(2);
        toggleLoader(false);
    }

    async function addRecord() {
        toggleLoader(true);
        const payload = {
            action: 'addRow',
            name: document.getElementById('name').value,
            room: document.getElementById('room').value,
            phone: document.getElementById('phone').value,
            item: document.getElementById('item').value,
            cost: document.getElementById('cost').value
        };
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        location.reload();
    }

    async function makePayment(id) {
        const amount = prompt("Enter amount paid:");
        if (amount) {
            toggleLoader(true);
            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action: 'update', id: id, amount: amount}) });
            loadData();
        }
    }

    async function deleteRecord(id) {
        if (confirm("Archive this record?")) {
            toggleLoader(true);
            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action: 'delete', id: id}) });
            loadData();
        }
    }

    function filterTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.getElementById("dataTable").getElementsByTagName("tr");
        for (let row of rows) {
            let name = row.getElementsByTagName("td")[1].textContent.toLowerCase();
            row.style.display = name.includes(input) ? "" : "none";
        }
    }

    loadData();
</script>
</body>
</html>
